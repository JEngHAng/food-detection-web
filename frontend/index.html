<script>
  async function detect() {
    const fileInput = document.getElementById("upload");
    if (!fileInput.files[0]) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö");
      return;
    }

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    document.getElementById("results-list").innerHTML = "‚è≥ Detecting...";

    try {
      const response = await fetch(
        "https://biogeographically-caliphal-kaidence.ngrok-free.dev/detect",
        {
          method: "POST",
          body: formData,
        }
      );

      const data = await response.json();

      // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤ backend ‡∏™‡πà‡∏á error ‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      if (data.error) {
        document.getElementById("results-list").innerHTML =
          "‚ùå " + data.error;
        return;
      }

      if (!data.detections && !data.components) {
        document.getElementById("results-list").innerHTML =
          "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö";
        return;
      }

      // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏û
      document.getElementById("result-image").src =
        "data:image/jpeg;base64," + data.image;

      // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      let html = "";

      if (data.predicted_menu && data.predicted_menu !== "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á") {
        html += `<h3>üçõ ${data.predicted_menu}</h3>`;
        html += "<strong>üîç ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</strong><br>";

        (data.components || []).forEach((comp) => {
          html += `‚Ä¢ ${comp.name} (${comp.confidence ?? 0}%)<br>`;
        });
      } else {
        html += "<h3>üçΩ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á</h3>";
        html += "<strong>üîç ‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö:</strong><br>";

        (data.detections || []).forEach((det) => {
          html += `‚Ä¢ ${det.name} (${det.confidence ?? 0}%)<br>`;
        });
      }

      document.getElementById("results-list").innerHTML = html;
    } catch (err) {
      document.getElementById("results-list").innerHTML =
        "‚ùå Error: " + err.message;
    }
  }
</script>
